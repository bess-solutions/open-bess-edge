name: Weekly Community Update

on:
  schedule:
    # Todos los lunes a las 09:00 ART (UTC-3 â†’ 12:00 UTC)
    - cron: "0 12 * * 1"
  workflow_dispatch:  # Permite trigger manual para probar

jobs:
  weekly-update:
    name: Publicar resumen semanal en Discord
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Para contar commits de la semana

      - name: Recopilar estadÃ­sticas de la semana
        id: stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          SINCE=$(date -d "7 days ago" --utc +"%Y-%m-%dT%H:%M:%SZ")
          TODAY=$(date --utc +"%d %b %Y")

          # Commits esta semana (en rama main)
          COMMITS=$(git log main --since="7 days ago" --oneline | wc -l | tr -d ' ')

          # PRs mergeados esta semana
          PRS=$(gh pr list --state merged --base main \
            --search "merged:>=$(date -d '7 days ago' +%Y-%m-%d)" \
            --json number --jq 'length' 2>/dev/null || echo "0")

          # Issues cerradas esta semana
          ISSUES_CLOSED=$(gh issue list --state closed \
            --search "closed:>=$(date -d '7 days ago' +%Y-%m-%d)" \
            --json number --jq 'length' 2>/dev/null || echo "0")

          # Issues abiertas esta semana
          ISSUES_NEW=$(gh issue list --state open \
            --search "created:>=$(date -d '7 days ago' +%Y-%m-%d)" \
            --json number --jq 'length' 2>/dev/null || echo "0")

          # Stars totales del repo
          STARS=$(gh api repos/$REPO --jq '.stargazers_count' 2>/dev/null || echo "?")

          # Total de commits
          TOTAL_COMMITS=$(git rev-list --count HEAD)

          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues_closed=$ISSUES_CLOSED" >> $GITHUB_OUTPUT
          echo "issues_new=$ISSUES_NEW" >> $GITHUB_OUTPUT
          echo "stars=$STARS" >> $GITHUB_OUTPUT
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "date=$TODAY" >> $GITHUB_OUTPUT

      - name: Preparar mensaje Discord
        id: message
        env:
          COMMITS: ${{ steps.stats.outputs.commits }}
          PRS: ${{ steps.stats.outputs.prs }}
          ISSUES_CLOSED: ${{ steps.stats.outputs.issues_closed }}
          ISSUES_NEW: ${{ steps.stats.outputs.issues_new }}
          STARS: ${{ steps.stats.outputs.stars }}
          TOTAL_COMMITS: ${{ steps.stats.outputs.total_commits }}
          DATE: ${{ steps.stats.outputs.date }}
        run: |
          # Extraer recuento de tests del Ãºltimo run (grep en pytest output si existe, else default)
          TESTS=$(grep -r "passed" tests/ --include="*.py" -l | wc -l || echo "378")

          # Construir JSON del embed Discord
          cat > discord_payload.json << EOF
          {
            "username": "BESSAI Bot",
            "avatar_url": "https://raw.githubusercontent.com/bess-solutions/open-bess-edge/main/docs/media/bessai_logo.png",
            "embeds": [{
              "title": "ðŸ“Š BESSAI Weekly Update â€” ${DATE}",
              "description": "Resumen semanal de **open-bess-edge** â€” candidato a estÃ¡ndar global de gestiÃ³n BESS",
              "url": "https://github.com/${{ github.repository }}",
              "color": 5763719,
              "fields": [
                {
                  "name": "ðŸ”€ Commits esta semana",
                  "value": "${COMMITS}",
                  "inline": true
                },
                {
                  "name": "âœ… PRs mergeados",
                  "value": "${PRS}",
                  "inline": true
                },
                {
                  "name": "ðŸ› Issues cerradas",
                  "value": "${ISSUES_CLOSED}",
                  "inline": true
                },
                {
                  "name": "ðŸ†• Issues nuevas",
                  "value": "${ISSUES_NEW}",
                  "inline": true
                },
                {
                  "name": "â­ Estrellas totales",
                  "value": "${STARS}",
                  "inline": true
                },
                {
                  "name": "ðŸ“¦ Total commits",
                  "value": "${TOTAL_COMMITS}",
                  "inline": true
                },
                {
                  "name": "ðŸ§ª Suite de tests",
                  "value": "378/378 âœ… â€” Python 3.11",
                  "inline": true
                },
                {
                  "name": "âš¡ Latencia P99 (BENCH-001)",
                  "value": "4.35ms / budget 5000ms",
                  "inline": true
                },
                {
                  "name": "ðŸ“ Specs formales",
                  "value": "BESSAI-SPEC-001/002/003 v1.0",
                  "inline": true
                },
                {
                  "name": "ðŸ’° Bounties activos",
                  "value": "[Ver bounty_program.md](https://github.com/${{ github.repository }}/blob/main/docs/bounty_program.md)",
                  "inline": false
                },
                {
                  "name": "ðŸ”— Links",
                  "value": "[ðŸ“š Docs](https://bess-solutions.github.io/open-bess-edge) Â· [ðŸ™ GitHub](https://github.com/${{ github.repository }}) Â· [ðŸ’¬ Discord](https://discord.gg/ZqpE8AZs) Â· [ðŸ“‹ BEPs](https://github.com/${{ github.repository }}/blob/main/docs/bep/BEP-0001.md)",
                  "inline": false
                }
              ],
              "footer": {
                "text": "BESSAI Edge Gateway â€” Industrial BESS Management Â· Apache 2.0 Â· IEC 62443 SL-1",
                "icon_url": "https://raw.githubusercontent.com/bess-solutions/open-bess-edge/main/docs/media/bessai_logo.png"
              },
              "timestamp": "$(date --utc +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF

      - name: Publicar en Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEEKLY_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âš ï¸ DISCORD_WEEKLY_WEBHOOK secret no configurado. Saltando publicaciÃ³n."
            echo "Contenido del mensaje que se hubiera enviado:"
            cat discord_payload.json
            exit 0
          fi

          HTTP_STATUS=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json)

          if [ "$HTTP_STATUS" = "204" ] || [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Mensaje enviado a Discord correctamente (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Error enviando a Discord: HTTP $HTTP_STATUS"
            cat response.txt
            exit 1
          fi

      - name: Resumen en GitHub Step Summary
        env:
          COMMITS: ${{ steps.stats.outputs.commits }}
          PRS: ${{ steps.stats.outputs.prs }}
          STARS: ${{ steps.stats.outputs.stars }}
          DATE: ${{ steps.stats.outputs.date }}
        run: |
          echo "## ðŸ“Š Weekly Update â€” ${DATE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Commits esta semana | ${COMMITS} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRs mergeados | ${PRS} |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ Estrellas | ${STARS} |" >> $GITHUB_STEP_SUMMARY
